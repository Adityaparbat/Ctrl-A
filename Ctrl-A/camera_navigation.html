<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Navigation - Ctrl-A</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-dark: #1a202c;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            --success-color: #38a169;
            --error-color: #e53e3e;
            --warning-color: #f6ad55;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Camera Section */
        .camera-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .camera-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error-color);
        }

        .status-indicator.active {
            background: var(--success-color);
        }

        .camera-container {
            position: relative;
            background: var(--bg-dark);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            aspect-ratio: 16/9;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .camera-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
        }

        .camera-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .camera-text {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .camera-subtext {
            font-size: 1rem;
            opacity: 0.7;
        }

        .camera-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-start {
            background: var(--gradient);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-stop {
            background: var(--error-color);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
        }

        .btn-capture {
            background: var(--gradient-accent);
            color: white;
        }

        .btn-capture:hover {
            transform: translateY(-2px);
        }

        /* Sign Language Recognition */
        .sign-recognition {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .sign-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sign-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .sign-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .sign-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .sign-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error-color);
        }

        .sign-indicator.active {
            background: var(--success-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sign-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .sign-buffer {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buffer-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }

        .buffer-empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .sign-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-sign {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-start-sign {
            background: var(--gradient);
            color: white;
        }

        .btn-start-sign:hover {
            transform: translateY(-2px);
        }

        .btn-stop-sign {
            background: var(--error-color);
            color: white;
        }

        .btn-stop-sign:hover {
            transform: translateY(-2px);
        }

        .btn-clear {
            background: var(--warning-color);
            color: white;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
        }

        /* Navigation Features */
        .navigation-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .feature-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .feature-card:nth-child(1) .feature-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .feature-card:nth-child(2) .feature-icon {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .feature-card:nth-child(3) .feature-icon {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .feature-card:nth-child(4) .feature-icon {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .feature-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feature-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .feature-btn {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Detection Results */
        .detection-results {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .results-count {
            background: var(--bg-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .detection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detection-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .detection-label {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .detection-confidence {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Audio Player */
        .audio-player {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .audio-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gradient);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-btn:hover {
            transform: scale(1.1);
        }

        .audio-info {
            flex: 1;
        }

        .audio-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .audio-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .nav {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .camera-controls {
                flex-direction: column;
            }

            .sign-actions {
                flex-direction: column;
            }

            .navigation-features {
                grid-template-columns: 1fr;
            }

            .detection-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --text-primary: #000000;
                --text-secondary: #333333;
                --border-color: #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <div class="logo">Ctrl-A</div>
            <div class="nav-right">
                <a href="/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
                <a id="openExternalApp" href="/navigation/" class="btn btn-primary" target="_blank" title="Opens the camera navigation app within this server">
                    <i class="fas fa-external-link-alt"></i>
                    Open Camera App
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title">Camera Navigation</h1>
            <p class="page-subtitle">
                Navigate your environment using advanced computer vision and sign language recognition
            </p>
        </section>

        <!-- Camera Section -->
        <section class="camera-section">
            <div class="camera-header">
                <h2 class="camera-title">Live Camera Feed</h2>
                <div class="camera-status">
                    <div class="status-indicator" id="cameraStatus"></div>
                    <span id="cameraStatusText">Camera Off</span>
                </div>
            </div>

            <div class="camera-container">
                <video id="cameraVideo" class="camera-video" autoplay muted></video>
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <div class="camera-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="camera-text">Camera Not Active</div>
                    <div class="camera-subtext">Click "Start Camera" to begin navigation assistance</div>
                </div>
            </div>

            <div class="camera-controls">
                <button class="control-btn btn-start" id="startCameraBtn">
                    <i class="fas fa-play"></i>
                    Start Camera
                </button>
                <button class="control-btn btn-stop" id="stopCameraBtn" style="display: none;">
                    <i class="fas fa-stop"></i>
                    Stop Camera
                </button>
                <button class="control-btn btn-capture" id="captureBtn" style="display: none;">
                    <i class="fas fa-camera"></i>
                    Capture Image
                </button>
            </div>
        </section>

        <!-- Sign Language Recognition -->
        <section class="sign-recognition">
            <div class="sign-header">
                <div class="sign-icon">
                    <i class="fas fa-hand-paper"></i>
                </div>
                <h2 class="sign-title">Sign Language Recognition</h2>
            </div>

            <div class="sign-status">
                <div class="sign-indicator" id="signStatus"></div>
                <span class="sign-text" id="signStatusText">Sign recognition inactive</span>
            </div>

            <div class="sign-buffer">
                <div class="buffer-text buffer-empty" id="signBuffer">No gestures detected</div>
            </div>

            <div class="sign-actions">
                <button class="btn-sign btn-start-sign" id="startSignBtn">
                    <i class="fas fa-play"></i>
                    Start Recognition
                </button>
                <button class="btn-sign btn-stop-sign" id="stopSignBtn" style="display: none;">
                    <i class="fas fa-stop"></i>
                    Stop Recognition
                </button>
                <button class="btn-sign btn-clear" id="clearSignBtn">
                    <i class="fas fa-eraser"></i>
                    Clear Text
                </button>
            </div>
        </section>

        <!-- Navigation Features -->
        <section class="navigation-features">
            <div class="feature-card">
                <div class="feature-header">
                    <div class="feature-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <h3 class="feature-title">Object Detection</h3>
                        <p class="feature-desc">Identify objects and obstacles in your environment</p>
                    </div>
                </div>
                <a href="#" class="feature-btn" onclick="toggleObjectDetection()">
                    <i class="fas fa-toggle-off"></i>
                    Toggle Detection
                </a>
            </div>

            <div class="feature-card">
                <div class="feature-header">
                    <div class="feature-icon">
                        <i class="fas fa-text-width"></i>
                    </div>
                    <div>
                        <h3 class="feature-title">Text Recognition</h3>
                        <p class="feature-desc">Read and identify text in your surroundings</p>
                    </div>
                </div>
                <a href="#" class="feature-btn" onclick="toggleTextRecognition()">
                    <i class="fas fa-toggle-off"></i>
                    Toggle OCR
                </a>
            </div>

            <div class="feature-card">
                <div class="feature-header">
                    <div class="feature-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <div>
                        <h3 class="feature-title">Navigation Assistance</h3>
                        <p class="feature-desc">Get audio guidance for safe navigation</p>
                    </div>
                </div>
                <a href="#" class="feature-btn" onclick="toggleNavigation()">
                    <i class="fas fa-toggle-off"></i>
                    Toggle Navigation
                </a>
            </div>

            <div class="feature-card">
                <div class="feature-header">
                    <div class="feature-icon">
                        <i class="fas fa-volume-up"></i>
                    </div>
                    <div>
                        <h3 class="feature-title">Audio Description</h3>
                        <p class="feature-desc">Hear detailed descriptions of your environment</p>
                    </div>
                </div>
                <a href="#" class="feature-btn" onclick="toggleAudioDescription()">
                    <i class="fas fa-toggle-off"></i>
                    Toggle Audio
                </a>
            </div>
        </section>

        <!-- Detection Results -->
        <section class="detection-results">
            <div class="results-header">
                <h3 class="results-title">Detection Results</h3>
                <div class="results-count" id="resultsCount">0 items detected</div>
            </div>

            <div class="detection-grid" id="detectionGrid">
                <!-- Detection results will be populated here -->
            </div>
        </section>

        <!-- Audio Player -->
        <div class="audio-player" id="audioPlayer">
            <div class="audio-controls">
                <button class="audio-btn" id="playBtn">
                    <i class="fas fa-play"></i>
                </button>
                <div class="audio-info">
                    <div class="audio-title" id="audioTitle">Audio Response</div>
                    <div class="audio-desc" id="audioDesc">Click play to hear the response</div>
                </div>
            </div>
            <audio id="audioElement" controls style="display: none;"></audio>
        </div>
    </main>

    <script src="sign_language.js"></script>
    <script>
        let cameraStream = null;
        let isCameraActive = false;
        let isSignRecognitionActive = false;
        let signBuffer = '';
        let detectionFeatures = {
            objectDetection: false,
            textRecognition: false,
            navigation: false,
            audioDescription: false
        };

        // Initialize camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                
                cameraStream = stream;
                isCameraActive = true;
                updateCameraStatus(true);
                
                // Start detection if features are enabled
                if (detectionFeatures.objectDetection || detectionFeatures.textRecognition) {
                    startDetection();
                }
                
            } catch (error) {
                console.error('Camera access denied:', error);
                alert('Camera access is required for navigation assistance. Please allow camera access and try again.');
            }
        }

        // Stop camera
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
            video.style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'flex';
            
            isCameraActive = false;
            updateCameraStatus(false);
        }

        // Update camera status
        function updateCameraStatus(active) {
            const status = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraStatusText');
            
            if (active) {
                status.classList.add('active');
                statusText.textContent = 'Camera Active';
            } else {
                status.classList.remove('active');
                statusText.textContent = 'Camera Off';
            }
        }

        // Start sign language recognition
        function startSignRecognition() {
            isSignRecognitionActive = true;
            updateSignStatus(true);
            
            // Simulate sign language recognition
            simulateSignRecognition();
        }

        // Stop sign language recognition
        function stopSignRecognition() {
            isSignRecognitionActive = false;
            updateSignStatus(false);
        }

        // Update sign recognition status
        function updateSignStatus(active) {
            const status = document.getElementById('signStatus');
            const statusText = document.getElementById('signStatusText');
            
            if (active) {
                status.classList.add('active');
                statusText.textContent = 'Sign recognition active - Make hand gestures';
            } else {
                status.classList.remove('active');
                statusText.textContent = 'Sign recognition inactive';
            }
        }

        // Simulate sign language recognition
        function simulateSignRecognition() {
            if (!isSignRecognitionActive) return;
            
            // Simulate detecting gestures
            const gestures = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', ' '];
            const randomGesture = gestures[Math.floor(Math.random() * gestures.length)];
            
            if (Math.random() < 0.3) { // 30% chance of detecting a gesture
                addToSignBuffer(randomGesture);
            }
            
            // Continue simulation
            setTimeout(simulateSignRecognition, 1000);
        }

        // Add to sign buffer
        function addToSignBuffer(character) {
            if (character === ' ') {
                signBuffer += ' ';
            } else {
                signBuffer += character;
            }
            
            updateSignBuffer();
            
            // Process complete words
            if (character === ' ') {
                processSignWord();
            }
        }

        // Update sign buffer display
        function updateSignBuffer() {
            const buffer = document.getElementById('signBuffer');
            if (signBuffer) {
                buffer.textContent = signBuffer;
                buffer.classList.remove('buffer-empty');
            } else {
                buffer.textContent = 'No gestures detected';
                buffer.classList.add('buffer-empty');
            }
        }

        // Process complete word from sign buffer
        function processSignWord() {
            const words = signBuffer.trim().split(' ');
            const lastWord = words[words.length - 1];
            
            if (lastWord.length > 0) {
                console.log('Sign word detected:', lastWord);
                // Process the word (e.g., send to AI assistant)
                processSignCommand(lastWord);
            }
        }

        // Process sign command
        function processSignCommand(word) {
            const command = word.toLowerCase();
            
            if (command.includes('help') || command.includes('assist')) {
                showResponse('I can help you with navigation. Try gestures for "left", "right", "forward", "stop"');
            } else if (command.includes('left')) {
                showResponse('Turning left guidance activated');
            } else if (command.includes('right')) {
                showResponse('Turning right guidance activated');
            } else if (command.includes('forward') || command.includes('go')) {
                showResponse('Moving forward guidance activated');
            } else if (command.includes('stop')) {
                showResponse('Stop guidance activated');
            } else {
                showResponse(`Sign detected: ${word}`);
            }
        }

        // Clear sign buffer
        function clearSignBuffer() {
            signBuffer = '';
            updateSignBuffer();
        }

        // Start detection
        function startDetection() {
            if (!isCameraActive) return;
            
            // Start real object detection
            startRealObjectDetection();
        }

        // Start real object detection
        function startRealObjectDetection() {
            if (!isCameraActive) return;
            
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            // Detection loop
            const detectObjects = () => {
                if (!isCameraActive) return;
                
                try {
                    // Draw current frame to canvas
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Process image for object detection
                    const objects = processImageForObjects(imageData);
                    
                    // Display results
                    displayDetectionResults(objects);
                    
                    // Continue detection
                    setTimeout(detectObjects, 2000);
                } catch (error) {
                    console.error('Detection error:', error);
                    // Fallback to simulation
                    simulateObjectDetection();
                }
            };
            
            // Start detection
            detectObjects();
        }

        // Process image for object detection
        function processImageForObjects(imageData) {
            // Simple color-based object detection
            const objects = [];
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Detect different colored regions
            const regions = detectColorRegions(data, width, height);
            
            // Convert regions to objects
            regions.forEach(region => {
                if (region.area > 1000) { // Minimum area threshold
                    const object = {
                        name: getObjectNameFromColor(region.color),
                        confidence: Math.min(0.9, region.area / 10000),
                        x: region.x,
                        y: region.y,
                        width: region.width,
                        height: region.height
                    };
                    objects.push(object);
                }
            });
            
            // Add some common objects if no regions detected
            if (objects.length === 0) {
                objects.push(
                    { name: 'Background', confidence: 0.8 },
                    { name: 'Surface', confidence: 0.7 }
                );
            }
            
            return objects.slice(0, 6); // Limit to 6 objects
        }

        // Detect color regions in image
        function detectColorRegions(data, width, height) {
            const regions = [];
            const visited = new Array(width * height).fill(false);
            
            for (let y = 0; y < height; y += 10) {
                for (let x = 0; x < width; x += 10) {
                    const index = (y * width + x) * 4;
                    if (visited[y * width + x]) continue;
                    
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    
                    // Skip very dark or very light pixels
                    const brightness = (r + g + b) / 3;
                    if (brightness < 30 || brightness > 225) continue;
                    
                    const region = floodFill(data, width, height, x, y, visited, r, g, b);
                    if (region.area > 500) {
                        regions.push(region);
                    }
                }
            }
            
            return regions;
        }

        // Flood fill algorithm for region detection
        function floodFill(data, width, height, startX, startY, visited, targetR, targetG, targetB) {
            const stack = [{x: startX, y: startY}];
            const region = {
                color: {r: targetR, g: targetG, b: targetB},
                area: 0,
                x: startX,
                y: startY,
                width: 0,
                height: 0,
                minX: startX,
                maxX: startX,
                minY: startY,
                maxY: startY
            };
            
            while (stack.length > 0) {
                const {x, y} = stack.pop();
                const index = y * width + x;
                
                if (visited[index]) continue;
                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                
                const pixelIndex = index * 4;
                const r = data[pixelIndex];
                const g = data[pixelIndex + 1];
                const b = data[pixelIndex + 2];
                
                // Check if pixel color is similar to target color
                const colorDiff = Math.abs(r - targetR) + Math.abs(g - targetG) + Math.abs(b - targetB);
                if (colorDiff > 30) continue;
                
                visited[index] = true;
                region.area++;
                region.minX = Math.min(region.minX, x);
                region.maxX = Math.max(region.maxX, x);
                region.minY = Math.min(region.minY, y);
                region.maxY = Math.max(region.maxY, y);
                
                // Add neighbors to stack
                stack.push({x: x + 1, y}, {x: x - 1, y}, {x, y: y + 1}, {x, y: y - 1});
            }
            
            region.width = region.maxX - region.minX;
            region.height = region.maxY - region.minY;
            region.x = region.minX;
            region.y = region.minY;
            
            return region;
        }

        // Get object name from color
        function getObjectNameFromColor(color) {
            const {r, g, b} = color;
            
            if (r > g && r > b) {
                return 'Red Object';
            } else if (g > r && g > b) {
                return 'Green Object';
            } else if (b > r && b > g) {
                return 'Blue Object';
            } else if (r > 200 && g > 200 && b > 200) {
                return 'Light Surface';
            } else if (r < 50 && g < 50 && b < 50) {
                return 'Dark Object';
            } else {
                return 'Colored Object';
            }
        }

        // Simulate object detection (fallback)
        function simulateObjectDetection() {
            if (!isCameraActive) return;
            
            const objects = [
                { name: 'Person', confidence: 0.95 },
                { name: 'Chair', confidence: 0.87 },
                { name: 'Table', confidence: 0.82 },
                { name: 'Door', confidence: 0.78 },
                { name: 'Window', confidence: 0.73 },
                { name: 'Lamp', confidence: 0.69 }
            ];
            
            // Randomly select 2-4 objects
            const numObjects = Math.floor(Math.random() * 3) + 2;
            const selectedObjects = objects.sort(() => 0.5 - Math.random()).slice(0, numObjects);
            
            displayDetectionResults(selectedObjects);
            
            // Continue detection
            setTimeout(simulateObjectDetection, 3000);
        }

        // Display detection results
        function displayDetectionResults(objects) {
            const grid = document.getElementById('detectionGrid');
            const count = document.getElementById('resultsCount');
            
            count.textContent = `${objects.length} item${objects.length !== 1 ? 's' : ''} detected`;
            
            grid.innerHTML = objects.map(obj => `
                <div class="detection-item">
                    <div class="detection-label">${obj.name}</div>
                    <div class="detection-confidence">${Math.round(obj.confidence * 100)}% confidence</div>
                </div>
            `).join('');
        }

        // Toggle detection features
        function toggleObjectDetection() {
            detectionFeatures.objectDetection = !detectionFeatures.objectDetection;
            updateFeatureButton('objectDetection', detectionFeatures.objectDetection);
            
            if (detectionFeatures.objectDetection && isCameraActive) {
                startDetection();
            }
        }

        function toggleTextRecognition() {
            detectionFeatures.textRecognition = !detectionFeatures.textRecognition;
            updateFeatureButton('textRecognition', detectionFeatures.textRecognition);
        }

        function toggleNavigation() {
            detectionFeatures.navigation = !detectionFeatures.navigation;
            updateFeatureButton('navigation', detectionFeatures.navigation);
        }

        function toggleAudioDescription() {
            detectionFeatures.audioDescription = !detectionFeatures.audioDescription;
            updateFeatureButton('audioDescription', detectionFeatures.audioDescription);
        }

        // Update feature button
        function updateFeatureButton(feature, active) {
            const buttons = document.querySelectorAll(`[onclick*="${feature}"]`);
            buttons.forEach(btn => {
                const icon = btn.querySelector('i');
                if (active) {
                    icon.className = 'fas fa-toggle-on';
                    btn.style.color = 'var(--success-color)';
                } else {
                    icon.className = 'fas fa-toggle-off';
                    btn.style.color = 'var(--text-primary)';
                }
            });
        }

        // Show response
        function showResponse(message) {
            console.log('Response:', message);
            // In a real implementation, this would show a toast or notification
        }

        // Play audio
        function playAudio(audioUrl, title) {
            const audioPlayer = document.getElementById('audioPlayer');
            const audioElement = document.getElementById('audioElement');
            const playBtn = document.getElementById('playBtn');
            const audioTitle = document.getElementById('audioTitle');
            const audioDesc = document.getElementById('audioDesc');

            audioElement.src = audioUrl;
            audioTitle.textContent = 'Audio Response';
            audioDesc.textContent = title;
            audioPlayer.style.display = 'block';

            playBtn.onclick = function() {
                if (audioElement.paused) {
                    audioElement.play();
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    audioElement.pause();
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            };

            audioElement.onended = function() {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
            };
        }

        // Event listeners
        document.getElementById('startCameraBtn').addEventListener('click', function() {
            initCamera();
            this.style.display = 'none';
            document.getElementById('stopCameraBtn').style.display = 'inline-flex';
            document.getElementById('captureBtn').style.display = 'inline-flex';
        });

        document.getElementById('stopCameraBtn').addEventListener('click', function() {
            stopCamera();
            this.style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'inline-flex';
            document.getElementById('captureBtn').style.display = 'none';
        });

        document.getElementById('captureBtn').addEventListener('click', function() {
            if (isCameraActive) {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg');
                console.log('Image captured:', imageData);
                showResponse('Image captured successfully');
            }
        });

        document.getElementById('startSignBtn').addEventListener('click', function() {
            if (window.signLanguageRecognition) {
                if (!window.signLanguageRecognition.isActive) {
                    window.signLanguageRecognition.initCamera().then(success => {
                        if (success) {
                            window.signLanguageRecognition.startRecognition();
                            this.style.display = 'none';
                            document.getElementById('stopSignBtn').style.display = 'inline-flex';
                            isSignRecognitionActive = true;
                        } else {
                            alert('Camera access is required for sign language recognition.');
                        }
                    });
                }
            } else {
                alert('Sign language recognition module not loaded.');
            }
        });

        document.getElementById('stopSignBtn').addEventListener('click', function() {
            if (window.signLanguageRecognition) {
                window.signLanguageRecognition.stopRecognition();
                this.style.display = 'none';
                document.getElementById('startSignBtn').style.display = 'inline-flex';
                isSignRecognitionActive = false;
            }
        });

        document.getElementById('clearSignBtn').addEventListener('click', function() {
            clearSignBuffer();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for camera support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Camera access is not supported in this browser.');
            }
            
            // Listen for sign language commands
            document.addEventListener('signLanguageCommand', function(event) {
                const command = event.detail.command;
                
                switch(command) {
                    case 'help':
                        showResponse('I can help you navigate using the camera. Try saying "start camera" or "detect objects".');
                        break;
                    case 'camera':
                        startCamera();
                        break;
                    case 'detect':
                        if (isCameraActive) {
                            startRealObjectDetection();
                        } else {
                            showResponse('Please start the camera first.');
                        }
                        break;
                    case 'clear':
                        showResponse('Cleared. How can I help you navigate?');
                        break;
                    default:
                        showResponse(`I heard: ${command}. How can I help you with camera navigation?`);
                }
            });
        });
    </script>
</body>
</html>
